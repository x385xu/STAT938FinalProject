


```{r envSetup, include = FALSE, echo = FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    message = FALSE,
    warning = FALSE,
    out.width = "65%",
    fig.align = "center",
    comment = ">"
    )
```



```{r, include = FALSE, echo = FALSE}
#library(tidyverse)
library(corrr)
library(psych)
library(lavaan)
#library(kableExtra)
library(dplyr)
library(tidyr)
library(ggplot2)
library(survey)
library(haven)
library(rempsyc)
library(broom)
library(report)
library(effectsize)
library(aod)
library(readr)
#library(tidymodels)
library(stargazer)
library(forcats)
library(ggcorrplot)
library(caret)
library(knitr)
library(ROCR)
library(jtools)
#=library(car)
library(xtable)
#library(texreg)
#library(svyVGAM)
library(glmnet)
library(ggpubr)
library(lme4)
library(nlme)
library(weights)
library(miscTools)
library(systemfit)
library(multcomp)
require(ggplot2)
require(GGally)
require(reshape2)
#require(compiler)
#require(parallel)
#require(boot)
require(lattice)
library(HLMdiag)
#library(DHARMa)
library(car) #for the Levene test which we will not discuss here
library(Matrix)
library(brms)
library(margins)
library(performance)
library(ggnewscale)
library(ggeffects)
library(bayestestR) # for hypothesis testing
library(brmsmargins)
library(ggeffects)
library(marginaleffects)
library(effects)
library(margins)
library(modelr)
library(plm)
library(effectsize)
library(aod)
library(readr)
library(tidymodels)
library(stargazer)
library(forcats)
library(ggcorrplot)
library(caret)
library(knitr)
library(ROCR)
library(jtools)
#=library(car)
library(xtable)
#library(texreg)
#library(svyVGAM)
library(glmnet)
library(ggpubr)
library(foreign)
library(AER)
library(lme4)
library(brms)
library(glmnet)
library(ggpubr)
library(formatR)
library(pglm)
library(acqr)
library(readr)
library(tidymodels)
library(foreign)
library(NLP)
library(tm) # text mining 
library(tidytext) # text analysis 
#library(janeaustenr)
library(stringr)
library(igraph) # manipulating and analyzing networks
library(ggraph)
library(igraph)
library(widyr)
#library(tm.plugin.webmining)
library(purrr)
library(topicmodels)
library(scales)
#library(mallet) 
library(cld2)
library(readxl)
library(reshape2)
library(pheatmap)
library(stopwords)
library(gridExtra)
library(grid)
library(reshape2)
library(igraph)
library(treemapify)
library(networkD3)
library(tidyr)
library(ggeffects)
library(sandwich)
library(lmtest)
library(pscl)
library(texreg)
library(geepack)
# Packages required for Chapter 4
library(gridExtra)
library(knitr)
library(kableExtra)
library(mosaic)
library(xtable)
library(pscl) 
library(multcomp)
library(pander)
library(MASS)
library(tidyverse)

```



```{r}
df_00_fl <- readRDS("fl_statewide.rds")

```

```{r}
dim(df_00_fl)
```


```{r}
colnames(df_00_fl)
```

```{r}
main_df <- df_00_fl
df <- main_df
```


```{r}
glimpse(df)
```

```{r}
df2 <- df %>% dplyr::select(date, time, location, county_name, department_name, subject_age, subject_race, 
                            subject_sex, officer_age, officer_race, officer_sex, officer_years_of_service, type, violation, arrest_made, outcome, search_conducted)
```

```{r}
df_nonaage <- df %>% filter(!is.na(officer_age), !is.na(search_conducted))

```

```{r}
dim(df_nonaage)
```



```{r}
df_nonaage %>% summarise(
    meanage = mean(officer_age),
    std = sd(officer_age),
    median = median(officer_age),
    skeww = skew(officer_age)
)


```

```{r}
df_nonaage %>% group_by(search_conducted) %>% summarise(
    meanage = mean(officer_age),
    std = sd(officer_age),
    median = median(officer_age),
)
```

```{r}
df_nonaage %>% group_by(search_conducted) %>% count()
```


# Visualizations 
```{r}
df2_no_na <- df2 %>% filter(if_all(everything(), ~ !is.na(.)))

```


```{r}
dim(df2_no_na)
```


```{r}
df2_clean <- df2_no_na
```




```{r}
categorical_summary <- function(data) {
  data %>%
    dplyr::select(where(~ is.factor(.) || is.character(.))) %>%
    purrr::map_dfr(
      ~ as.data.frame(table(.x, useNA = "ifany")) %>%
        dplyr::mutate(Percent = round(100 * Freq / sum(Freq), 2)),
      .id = "Variable"
    )
}

```


```{r}
paste("Number of unique dates in dataset are ", n_distinct(df2$date), ".")
paste("Number of unique times in dataset are ", n_distinct(df2$time), ".")
paste("Number of unique locations in dataset are ", n_distinct(df2$location), ".")
paste("Number of unique counties in dataset are ", n_distinct(df2$county_name), ".")
paste("Number of unique departments in dataset are ", n_distinct(df2$department_name), ".")
paste("Number of unique subject ages in dataset are ", n_distinct(df2$subject_age), ".")
paste("Number of unique subject races in dataset are ", n_distinct(df2$subject_race), ".")
paste("Number of unique subject genders in dataset are ", n_distinct(df2$subject_sex), ".")
paste("Number of unique officer ages in dataset are ", n_distinct(df2$officer_age), ".")
paste("Number of unique officer races in dataset are ", n_distinct(df2$officer_race), ".")
paste("Number of unique officer genders in dataset are ", n_distinct(df2$officer_sex), ".")
paste("Number of unique officer years of service in dataset are ", n_distinct(df2$officer_years_of_service), ".")
paste("Number of unique types of stop in dataset are ", n_distinct(df2$type), ".")
paste("Number of unique violation in dataset are ", n_distinct(df2$violation), ".")
paste("Number of unique arrest results in dataset are ", n_distinct(df2$arrest_made), ".")
paste("Number of unique outcomes in dataset are ", n_distinct(df2$outcome), ".")
paste("Number of unique search binary in dataset are ", n_distinct(df2$search_conducted), ".")


```



```{r}
paste("Number of unique dates in dataset are ", n_distinct(df2_clean$date), ".")
paste("Number of unique times in dataset are ", n_distinct(df2_clean$time), ".")
paste("Number of unique locations in dataset are ", n_distinct(df2_clean$location), ".")
paste("Number of unique counties in dataset are ", n_distinct(df2_clean$county_name), ".")
paste("Number of unique departments in dataset are ", n_distinct(df2_clean$department_name), ".")
paste("Number of unique subject ages in dataset are ", n_distinct(df2_clean$subject_age), ".")
paste("Number of unique subject races in dataset are ", n_distinct(df2_clean$subject_race), ".")
paste("Number of unique subject genders in dataset are ", n_distinct(df2_clean$subject_sex), ".")
paste("Number of unique officer ages in dataset are ", n_distinct(df2_clean$officer_age), ".")
paste("Number of unique officer races in dataset are ", n_distinct(df2_clean$officer_race), ".")
paste("Number of unique officer genders in dataset are ", n_distinct(df2_clean$officer_sex), ".")
paste("Number of unique officer years of service in dataset are ", n_distinct(df2_clean$officer_years_of_service), ".")
paste("Number of unique types of stop in dataset are ", n_distinct(df2_clean$type), ".")
paste("Number of unique violation in dataset are ", n_distinct(df2_clean$violation), ".")
paste("Number of unique arrest results in dataset are ", n_distinct(df2_clean$arrest_made), ".")
paste("Number of unique outcomes in dataset are ", n_distinct(df2_clean$outcome), ".")
paste("Number of unique search binary in dataset are ", n_distinct(df2_clean$search_conducted), ".")

```

```{r}
df3 <- df2_clean %>% dplyr::select(subject_race, department_name, subject_sex, officer_race, officer_sex, arrest_made, outcome, search_conducted)
```

```{r}
xtable(categorical_summary(df3))
```

```{r}
time_summary <- function(data) {
  data %>%
    dplyr::select(where(~ inherits(., "Date") || inherits(., "POSIXct"))) %>%
    purrr::imap_dfr(~ {
      tibble::tibble(
        Variable = .y,
        Min = min(.x, na.rm = TRUE),
        Max = max(.x, na.rm = TRUE),
        Range = difftime(max(.x, na.rm = TRUE), min(.x, na.rm = TRUE), units = "days"),
        Missing = sum(is.na(.x)),
        Total = length(.x)
      )
    })
}

```

```{r}
summary_date <- tibble::tibble(
  Min = min(df2_clean$date, na.rm = TRUE),
  Max = max(df2_clean$date, na.rm = TRUE),
  Range = difftime(max(df2_clean$date, na.rm = TRUE), min(df2_clean$date, na.rm = TRUE), units = "days"),
  Missing = sum(is.na(df2_clean$date)),
  Total = length(df2_clean$date)
)
summary_date
```

```{r}
df$datetime <- as.POSIXct(paste(df$date, df$time), format = "%Y-%m-%d %H:%M:%S")
```

```{r}
df2_clean$datetime <- as.POSIXct(paste(df2_clean$date, df2_clean$time), format = "%Y-%m-%d %H:%M:%S")

```


```{r}
summary_date2 <- tibble::tibble(
  Min = min(df$datetime, na.rm = TRUE),
  Max = max(df$datetime, na.rm = TRUE),
  Range = difftime(max(df$datetime, na.rm = TRUE), min(df$datetime, na.rm = TRUE), units = "days"),
  Missing = sum(is.na(df$datetime)),
  Total = length(df$datetime)
)
summary_date2
```

```{r}
summary_date2 <- tibble::tibble(
  Min = min(df2_clean$datetime, na.rm = TRUE),
  Max = max(df2_clean$datetime, na.rm = TRUE),
  Range = difftime(max(df2_clean$datetime, na.rm = TRUE), min(df2_clean$datetime, na.rm = TRUE), units = "days"),
  Missing = sum(is.na(df2_clean$datetime)),
  Total = length(df2_clean$datetime)
)
summary_date2
```


```{r}
df_clean <- rename(df2,
       `subject age`= subject_age,
       `officer age`= officer_age,
       `officer years of service` = officer_years_of_service)
       
```

```{r}
#rownames(heatmap_data) <- FACandNSFAC_pivot$FAC
corM <- Hmisc::rcorr(as.matrix(
    df_clean %>% dplyr::select_if(is.numeric)
))

# Extract the correlation values (correlation matrix)
reg_corM <- as.data.frame(corM$r)

# Step 2: Remove columns and rows with all NA values
reg_corM <- reg_corM %>%
  dplyr::select(where(~ !all(is.na(.)))) %>%
  filter(rowSums(is.na(.)) < ncol(.))

# Step 3: Convert to a numeric matrix and replace NA with 0 (optional)
data <- as.matrix(reg_corM)
data[is.na(data)] <- 0  # Replace NA with 0 if needed



```

```{r}
pheatmap::pheatmap(data,
         main = "Heatmap of Correlation Matrix",
         display_numbers = TRUE,  # Show correlation values
         clustering_distance_rows = "euclidean",  # Distance metric for clustering
         clustering_distance_cols = "euclidean",
         clustering_method = "complete",  # Hierarchical clustering method
         color = colorRampPalette(c("white", "lightblue", "gray"))(50))
           
           #colorRampPalette(c("cyan", "white", "orange"))(50))  # Customize color palette

```

```{r}
cor_values <- as.data.frame(corM$r)   
p_values <- as.data.frame(corM$P) 


```

```{r}
p_values
```

```{r}
searched <- df_clean %>% filter(search_conducted == "TRUE")
```

```{r}
ggplot(searched, aes(x = subject_race)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Searches by Race",
       x = "Race",
       y = "Number of Searches") +
  theme_minimal()
```

```{r, fig.height=4, fig.width=10}
# df > df2_clean 

sbjct_race_search <- df %>% filter(!is.na(subject_race), !is.na(search_conducted)) %>% 
      count(subject_race, search_conducted) %>%
      ggplot(aes(x = as.factor(search_conducted), y = n, fill = subject_race)) +
      geom_bar(stat = "identity", position = "fill") +
      labs(fill = "Race", x = "Search Conducted", y = "Proportion", title = "Subject Race & Searches") +
      scale_fill_brewer(palette = "Set2") +
      theme_minimal()

officer_race_search <- df %>% filter(!is.na(officer_race), !is.na(search_conducted)) %>% 
      count(officer_race, search_conducted) %>%
      ggplot(aes(x = as.factor(search_conducted), y = n, fill = officer_race)) +
      geom_bar(stat = "identity", position = "fill") +
      labs(fill = "Race", x = "Search Conducted", y = "Proportion", title = "Officer Race & Searches") +
      scale_fill_brewer(palette = "Set1") +
      theme_minimal()

ggarrange(sbjct_race_search, officer_race_search, ncol = 2)
```



```{r, fig.height=4, fig.width=10}
# df > df2_clean 
sex_subject_search <- df %>% filter(!is.na(subject_sex), !is.na(search_conducted)) %>% 
      count(subject_sex, search_conducted) %>%
      ggplot(aes(x = as.factor(search_conducted), y = n, fill = subject_sex)) +
      geom_bar(stat = "identity", position = "fill") +
      labs(fill = "Gender", x = "Search Conducted", y = "Proportion", title = "Subject Sex & Searches") +
      scale_fill_brewer(palette = "Set2") +
      theme_minimal()


sex_officer_search <- df %>% filter(!is.na(officer_sex), !is.na(search_conducted)) %>% 
      count(officer_sex, search_conducted) %>%
      ggplot(aes(x = as.factor(search_conducted), y = n, fill = officer_sex)) +
      geom_bar(stat = "identity", position = "fill") +
      labs(fill = "Gender", x = "Search Conducted", y = "Proportion", title = "Officer Sex & Searches") +
      scale_fill_brewer(palette = "Set3") +
      theme_minimal()

ggarrange(sex_subject_search, sex_officer_search, ncol = 2)

```


```{r}
df %>% filter(!is.na(subject_age)) %>% 
  filter(search_conducted == 1) %>%
  mutate(age_group = cut(subject_age, breaks = seq(0, 100, by = 10), right = FALSE)) %>%
  count(age_group) %>%
  ggplot(aes(x = age_group, y = n)) +
  geom_col(fill = "steelblue") +
  labs(title = "Number of Searches by Age Group",
       x = "Age Group",
       y = "Number of Searches") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, fig.height=4, fig.width=10}
sbjct_age_search <- df %>%
      filter(search_conducted == 1, !is.na(subject_age)) %>%
      count(subject_age) %>%
      ggplot(aes(x = subject_age, y = n)) +
      geom_line(color = "steelblue", size = 1) +
      labs(title = "Number of Searches by Subject Age",
           x = "Age (Subject)",
           y = "Number of Searches") +
      theme_minimal()

officer_age_search <- df %>%
      filter(search_conducted == 1, !is.na(officer_age)) %>%
      count(officer_age) %>%
      ggplot(aes(x = officer_age, y = n)) +
      geom_line(color = "darkred", size = 1) +
      labs(title = "Number of Searches by Officer Age",
           x = "Age (Officer)",
           y = "Number of Searches") +
      theme_minimal()

ggarrange(sbjct_age_search, officer_age_search, ncol = 2)
```

```{r}
df %>%
      filter(search_conducted == 1, !is.na(officer_years_of_service), officer_years_of_service >= 0) %>%
      count(officer_years_of_service) %>%
      ggplot(aes(x = officer_years_of_service, y = n)) +
      geom_line(color = "darkgreen", size = 1) +
      labs(title = "Number of Searches Based on Officer's Years of Service",
           x = "Officer Years of Service",
           y = "Number of Searches") +
      theme_minimal()
```


```{r}
summary_df <- df %>% filter(!is.na(officer_age), !is.na(officer_race)) %>% 
  group_by(officer_age, officer_race) %>%
  summarise(num_search = count(search_conducted), .groups = "drop")

```

```{r, fig.width=10, fig.height=5}
ggplot(summary_df, aes(x = officer_age, y = num_search, color = as.factor(officer_race))) +
  geom_line(linewidth = 1) +  
  geom_point(alpha = 0.6) +   # optional: points on top
  geom_smooth(se = FALSE, method = "loess", linetype = "dashed") +  
  labs(
    x = "Officer Age",
    y = "Number of Searches",
    color = "Officer Race",
    title = "Number of Searches by Officer Age and Race"
  ) +
  theme_minimal()
```


```{r}
ggplot(summary_df, aes(x = officer_age, y = num_search)) +
  geom_line(color = "steelblue") +
  geom_smooth(method = "loess", se = FALSE, linetype = "dashed", color = "gray40") +
  facet_wrap(~ officer_race, scales = "free_y") +
  labs(
    title = "Number of Searches by Officer Age, Faceted by Officer Race",
    x = "Officer Age",
    y = "Number of Searches"
  ) +
  theme_minimal()

```

```{r}
ggplot(summary_df, aes(x = officer_age, y = officer_race, fill = num_search)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(
    title = "Heatmap of Searches by Officer Age and Race",
    x = "Officer Age",
    y = "Officer Race",
    fill = "Searches"
  ) +
  theme_minimal()

```



```{r}
ggplot(summary_df, aes(x = officer_race, y = num_search, color = officer_race)) +
  stat_summary(fun = mean, geom = "point") +
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", width = 0.5) +
  labs(
    x = "Officer Race",
    y = "Average Number of Searches per Age Group",
    title = "Variation in Searches by Officer Race",
    color = "Officer Race"
  ) +
  theme_bw(base_size = 12) +
  theme(legend.position = "none")


```




```{r}
ggplot(aes(x = officer_age, y = log(num_search), color = as.factor(officer_race)), data = summary_df) + 
    stat_summary(fun.data = "mean_cl_boot", geom = 'line', aes(group = as.factor(officer_race))) +
    labs(x = "Officer Age", y = "Number of Searches (log base 10)", color = "Officer Race") + 
    scale_color_brewer(palette = "Dark2") +
    theme_minimal()
```

```{r}
wrk_df3 <- wrk_df3 %>% mutate(
    search_conducted_int = as.integer(search_conducted)
)
```

```{r}
ggplot(df, aes(officer_age, as.integer(search_conducted), color = as.factor(officer_race))) +
                  stat_summary(fun = mean, geom = "point") +
                  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", width = 0.4) +
                  theme_set(theme_bw(base_size = 10)) +
                  theme(legend.position = "top") +
                  labs(x = "Officer Age", y = "Observed Probabilty of Conducting a Search", color = "Officer Race") + theme_minimal()
```

# Age Group 
```{r}
df_nonaage <- df %>% filter(!is.na(officer_age))
cuts <- cut(df_nonaage$officer_age, breaks = c(20,25,30,35,40,45,50,55,65))
ageGrps <- data.frame(cuts, df_nonaage)
ageGrps <- ageGrps[!is.na(ageGrps$cuts), ]  # remove NA



```


```{r}
df_nonaage %>% 
  ggplot(aes(x = officer_age)) + 
  geom_histogram(binwidth = .4) +
  scale_x_continuous(breaks = seq(20, 65, 5))
  labs(x = "Officer Age", y = "Frequency",
       title = "Distribution of Officer Age") +
  theme_minimal()

```

# IGNORE --- 
This was testing out different age groupings. 
```{r}
#library(rpart)


```

```{r}
# Fit decision tree
#tree_model <- rpart(search_conducted ~ officer_age, data = df_nonaage, method = "class",
                    control = rpart.control(cp = 0.001, minsplit = 100000))
# View the tree splits
#print(tree_model)

```


```{r}
# df_balanced <- df_nonaage %>% filter(!is.na(search_conducted)) %>% 
#   group_by(search_conducted) %>%
#   sample_n(min(table(df_nonaage$search_conducted))) %>%
#   ungroup()
# 
# tree_model <- rpart(search_conducted ~ officer_age, data = df_balanced, method = "class",
#                     control = rpart.control(cp = 0.001))
```

```{r}
# tree_model
```


```{r}
# library(rpart)
# rpart.plot::rpart.plot(tree_model)


```

```{r}
# df_nonaage <- df_nonaage %>% filter(!is.na(search_conducted))
```


```{r}
cuts <- cut(df_nonaage$officer_age, breaks = c(20,25,30,35,40,45,50,55,65))
ageGrps <- data.frame(cuts, df_nonaage)
ageGrps <- ageGrps[!is.na(ageGrps$cuts), ]  # remove NA

```


```{r}
ageGrps$cuts <- as.factor(ageGrps$cuts)  # ensure it's a factor
ageGrps <- ageGrps %>% mutate(
    cuts = relevel(cuts, ref = "(40,45]")
)

model <- glm(search_conducted ~ cuts, data = ageGrps, family = "binomial")
summary(model)

```

```{r}
summ(model,
     digits = 3,
     confint = T,
     ci.width = getOption("summ-ci.width", 0.95),
     exp = T)
```

To calculate odds ratios in probability terms: 
```{r}
1 - 0.145
```


```{r}
model2 <- glm(search_conducted ~ officer_age, data = ageGrps, family = "binomial")
summary(model2)
```


```{r}
summ(model2,
     digits = 3,
     confint = T,
     ci.width = getOption("summ-ci.width", 0.95),
     exp = T)
```

```{r}
nullmodel <- glm(search_conducted ~ 1, data = ageGrps, family = "binomial")

```

```{r}
anova(model, nullmodel)
```

```{r}
lrtest(nullmodel, model)
```


```{r}
anova(model2, nullmodel)

```

```{r}
lrtest(model2, nullmodel)

```


```{r}
anova(model2, model)
```

```{r}
lrtest(model2, model)

```


```{r}
# Extract the split points
# age_splits <- sort(unique(tree_model$splits[, "index"]))

# Print split values
# print(age_splits)


```

```{r}
# Create age group variable using the splits
# df_nonaage$age_group <- cut(df_nonaage$officer_age, 
#                             breaks = c(-Inf, age_splits, Inf), 
#                             right = FALSE, 
#                             labels = paste0("Group", seq_along(c(age_splits, Inf))))
# 
# # View frequency table
# table(df_nonaage$age_group)

```


```{r}
ageGrps %>%
  group_by(cuts, search_conducted) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(cuts) %>%
  mutate(prop = n / sum(n)) %>%
```

```{r}
ageGrps %>%
  group_by(cuts) %>%
  summarise(search_rate = mean(search_conducted), .groups = "drop") %>%
  ggplot(aes(x = cuts, y = search_rate, group = 1)) +
  geom_line() +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "Officer Age Group", y = "Search Rate",
       title = "Search Rate by Officer Age Group") +
  theme_minimal()
```


```{r}
ageGrps %>%
  count(cuts) %>%
  arrange(desc(n))

```





```{r}
ageGrps %>%
  group_by(cuts) %>%
  summarize(prop = mean(search_conducted),
            se = sd(search_conducted) / sqrt(n()),
            lower = prop - 1.96*se,
            upper = prop + 1.96*se) %>%
  ggplot(aes(x = cuts, y = prop)) +
  geom_col(fill = "skyblue") +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2)

```


```{r}
df %>% filter(!is.na(officer_age)) %>% group_by(officer_age) %>%
  summarise(
    prop = mean(search_conducted, na.rm = TRUE),
    n = n()
  ) %>%
  filter(prop > 0 & prop < 1) %>%
  mutate(log_odds = log(prop / (1 - prop))) %>%
  ggplot(aes(x = officer_age, y = log_odds)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(title = "Log-Odds of Search vs Officer Age",
       y = "Log-Odds", x = "Officer Age")
```

# testing out whether a non-linearity would improve things 
```{r}
model3 <- glm(search_conducted ~ officer_age + I(officer_age^2), data = ageGrps, family = "binomial")
anova(model2, model3, test = "Chisq")

```



```{r, fig.width=10, fig.height=5}
ggplot(wrk_df3, aes(officer_age, search_conducted_int, color = as.factor(officer_race))) +
                  stat_summary(fun = mean, geom = "point") +
                  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", width = 0.4) +
                  theme_set(theme_bw(base_size = 10)) +
                  theme(legend.position = "top") +
                  labs(x = "Officer Age", y = "Observed Probabilty of Conducting a Search", color = "Officer Race") + theme_minimal()
```


### TEST - Chi-Squared

```{r}
ctab <- table(df2_clean$subject_race, df2_clean$search_conducted)
ctab
```

```{r}
ctab <- ctab[rowSums(ctab) > 0, colSums(ctab) > 0]

chisq.test(ctab)
```



### Some additional analysis 

```{r}
cur_df %>%
  group_by(officer_age, search_conducted) %>%
  count() %>%
  ggplot(aes(x = officer_age, y = n, fill = search_conducted)) +
  geom_bar(stat = "identity") +
  labs(x = "Officer Age", y = "Number of Stops", fill = "Search Conducted") +
  theme_minimal()
```

```{r}
cur_df %>%
  group_by(officer_age) %>%
  summarise(search_rate = mean(search_conducted)) %>%
  ggplot(aes(x = officer_age, y = search_rate)) +
  geom_line() +
  geom_point() +
  labs(x = "Officer Age", y = "Proportion of Searches Conducted") +
  theme_minimal()
```

```{r}
cur_df %>%
  ggplot(aes(x = officer_age, y = as.numeric(search_conducted))) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
  labs(x = "Officer Age", y = "Probability of Search (Fitted)") +
  theme_minimal()
```



```{r}
wrk_df <- df2_clean
```

```{r}
colnames(wrk_df)
```
```{r}
wrk_df %>% group_by(officer_age) %>% count(officer_age)
```

```{r}
wrk_df2 <- wrk_df %>% group_by(officer_age) %>% count(officer_age)
```

```{r}
df <- df %>% add_count(officer_age,
                       name = "total_stop_by_age")
```

```{r}
wrk_df3 <- df2_clean %>% add_count(officer_age,
                       name = "total_stop_by_age")
```

```{r}
wrk_df4 <- df2_clean %>% dplyr::select(officer_age, officer_sex, officer_race, search_conducted, subject_age, subject_race, subject_sex) %>% group_by(officer_age) %>% mutate(
    num_searches = sum(search_conducted)
) %>% ungroup()
```

```{r}
sum(is.na(wrk_df4))
```
```{r}
wrk_df_new <- wrk_df3 %>% filter(officer_race != "unknown")
```


```{r}
wrk_df5 <- wrk_df3 %>% filter(officer_race != "unknown",
                              subject_race != "unknown")
```

```{r}
wrk_df6 <- df %>% group_by(officer_age) %>% count(total_stop_by_age)
```



```{r}
ggplot(wrk_df_new, aes(x = as.factor(officer_age), fill = as.factor(search_conducted))) +
  geom_bar(position = "fill", color = "black") +
  scale_fill_manual(values = c("FALSE" = "#E74C3C", "TRUE" = "#1ABC9C"),
                    name = "Search Conducted", labels = c("No", "Yes")) +
  labs(x = "Officer Age", y = "Proportion of Stops",
       title = "Proportion of Stops with/without Search by Officer Age") +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  )

```

```{r}

plot_df <- wrk_df %>%
  group_by(officer_age) %>%
  summarise(
    total = n(),
    searches = sum(search_conducted),
    prop_search = searches / total
  )

# Plot proportion
ggplot(plot_df, aes(x = officer_age, y = prop_search)) +
  geom_line(size = 1.2, color = "#2C3E50") +
  geom_point(color = "#1ABC9C", size = 2) +
  labs(x = "Officer Age", y = "Proportion of Searches",
       title = "Search Conducted by Officer Age") +
  theme_minimal(base_size = 13)



    #facet_wrap(~ USR_TYP) +
    #scale_fill_brewer(palette = "Set1", name = "PC Use", labels = c("No Use", "Use")) +

```


```{r}
ggplot(wrk_df_new %>%
           group_by(officer_age) %>%
           mutate(proportionSearch = mean(as.integer(search_conducted))), 
       aes(x = officer_age, y = proportionSearch, color = officer_race, group = officer_race)) +
  geom_line(size = 1) +  
  geom_point(size = 3) +  
  labs(
    x = "Officer Age",
    y = "Proportion of Searches",
    title = "Proportion of Searches by Officer Age Based on Race",
    color = "Officer Race"
  ) +
  theme_minimal() + theme(strip.text = element_text(size = 12, face = "bold"), axis.text.x = element_text(face = "bold"))
```


```{r fig.width=10, fig.height=5}
df_summary <- wrk_df_new %>%
  group_by(officer_age, officer_race) %>%
  mutate(Proportion = mean(search_conducted))

ggplot(df_summary, aes(x = officer_age, y = Proportion, group = 1)) +
  geom_line(color = "blue") +
  geom_point(color = "blue", size = 1) +
  facet_wrap(~ officer_race) +
  labs(x = "Officer Age", y = "Proportion of Searches Conducted") +
  theme_minimal()
```


```{r, fig.width=10}
ggplot(wrk_df_new, aes(x = officer_age, y = total_stop_by_age)) +
    geom_col(aes(fill = as.factor(search_conducted)), 
             stat = "identity", color = "black", position = position_dodge(0.9)) +
    facet_wrap(~ officer_race) +
    labs(x = "Officer Age", y = "Total Number of Stops") +
    scale_fill_brewer(palette = "Set1", name = "Search Conducted", labels = c("No", "Yes")) +
    theme_minimal() + 
    theme(
        strip.text = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(face = "bold")
         )
```


```{r}
sort(unique(wrk_df$officer_age))
```

```{r}
cur_df <- wrk_df_new
```


```{r, fig.height=10, warning = FALSE}
cuts <- cut(cur_df$officer_age, breaks = c(20,25,30,35,40,45,50,55,65))
ageGrps <- data.frame(cuts, cur_df)
ageGrps <- ageGrps[!is.na(ageGrps$cuts), ]  # remove NA group

search_ageGrps <- ageGrps[ageGrps$search_conducted == TRUE, ]

ggplot(data = ageGrps, aes(x = officer_age)) +
    geom_histogram(binwidth = 0.5, color = "black", fill = "gray35") +
    facet_wrap(~cuts, scales = "free") + 
    labs(x = "Officer Age", y = "Number of Searches Conducted", title = "Searches Conducted by Officer Age Group") + 
    theme(strip.text = element_text(size = 10, face = "bold"),
          axis.text.x = element_text(size = 10),  # x-axis labels
        axis.text.y = element_text(size = 10))  # y-axis labels
        #axis.ticks.x = element_line(),          # x-axis ticks
        #axis.ticks.y = element_line())           # y-axis ticks)

```

```{r}

# df_summary <- wrk_df_new %>%
#   group_by(officer_age, officer_race) %>%
#   mutate(Proportion = mean(search_conducted))
# 
# cuts <- cut(cur_df$officer_age, breaks = c(20,25,30,35,40,45,50,55,65))
# ageGrps <- data.frame(cuts, cur_df)
# ageGrps <- ageGrps[!is.na(ageGrps$cuts), ]  # remove NA group

#search_ageGrps <- ageGrps[ageGrps$search_conducted == TRUE, ]

search_ageGrps %>% group_by(cuts) %>%   
    summarise(mnNum= round(mean(officer_age),3),
              v = round(var(officer_age),3),
              n=n())

```

```{r}
cur_df <- cur_df %>%
  mutate(officer_age_centered = officer_age - mean(officer_age, na.rm = TRUE))

```


```{r}
ggplot(ageGrps, aes(x = cuts, fill = search_conducted)) +
  geom_bar(position = "dodge") +
  labs(x = "Officer Age Group", y = "Count of Stops", fill = "Search Conducted") +
  theme_minimal()

```

```{r}
ageGrps %>%
  group_by(cuts) %>%
  summarise(search_rate = mean(search_conducted), .groups = "drop") %>%
  ggplot(aes(x = cuts, y = search_rate, group = 1)) +
  geom_line() +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "Officer Age Group", y = "Search Rate",
       title = "Search Rate by Officer Age Group") +
  theme_minimal()
```



```{r}

cur_df %>%
  ggplot(aes(x = officer_age, y = as.numeric(search_conducted))) + 
  geom_point() +
  #geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
  labs(x = "Officer Age", y = "Search Conducted (0 = No, 1 = Yes)",
       title = "Logistic Regression: Probability of Search vs. Officer Age") +
  theme_minimal()

```



```{r}
ageGrps %>% group_by(cuts)  %>% 
  summarise(mnNum= round(mean(search_conducted)/mean(officer_age),3),varNum=round(var(search_conducted),3),n=n())
```




```{r}
sumStats <- cur_df %>% group_by(officer_age) %>% 
  summarise(mntotal = mean(search_conducted),
            logmntotal = log(mntotal), n=n())

ggplot(sumStats, aes(x=officer_age, y=logmntotal)) +
  geom_point()+
  geom_smooth(method = "loess", size = 1.5)+
  xlab("Officer Age") +
  ylab("Log of Mean of Number of Searches") 
```

```{r}
ggplot(sumStats, aes(x=officer_age, y=mntotal)) +
  geom_point()+
  geom_smooth(method = "loess", size = 1.5)+
  xlab("Officer Age") +
  ylab("Average Number of Searches") 
```



```{r}
cur_df %>% group_by(officer_age) %>% 
  summarise(avg_search = mean(search_conducted)) %>% 
    ggplot(aes(x=officer_age, y=avg_search)) +
  geom_point()+
  geom_smooth(method = "loess", se=T) + 
    labs(x = "Officer Age", y = "Average Number of Searches",
         title = "Offcer Age vs Avg. No. of Searches")
```


```{r}
sumStats2 <- cur_df %>% group_by(officer_age, officer_sex) %>%
    count(search_conducted) %>% 
    summarise(mntotal = mean(n),
              logmntotal = log(mntotal))


```


```{r, fig.width=13, fig.height=5}
log_avg <- ggplot(sumStats2, aes(x=officer_age, y=logmntotal, color=officer_sex,
                      linetype = officer_sex, shape = officer_sex)) +
  geom_point()+
  geom_smooth(method = "loess", se=T)+
  xlab("Age of Officer") +
  ylab("Log of Average Number of Searches")+
    scale_color_manual(values = c("male" = "#E41A1C", "female" = "#377EB8")) +  # red & blue
  scale_linetype_manual(values = c("male" = "solid", "female" = "dashed")) +
  scale_shape_manual(values = c("male" = 16, "female" = 17)) +  # circle & triangle
  theme_minimal()


mean_avg2 <- ggplot(sumStats2, aes(x=officer_age, y=mntotal, color=officer_sex,
                      linetype = officer_sex, shape = officer_sex)) +
  geom_point()+
  geom_smooth(method = "loess", se=T)+
  xlab("Age of Officer") +
  ylab("Average Number of Searches")+
    scale_color_manual(values = c("male" = "#E41A1C", "female" = "#377EB8")) +  # red & blue
  scale_linetype_manual(values = c("male" = "solid", "female" = "dashed")) +
  scale_shape_manual(values = c("male" = 16, "female" = 17)) +  # circle & triangle
  theme_minimal()

ggarrange(log_avg, mean_avg2, ncol = 2,
          labels = c("a)", "b)"))
```

```{r}
colnames(df)
```

```{r}
age_rate_df <- ageGrps %>%
  group_by(cuts) %>%
  summarise(
    total_stops = n(),
    searches = sum(search_conducted),
    search_rate = searches / total_stops
  )

ggplot(age_rate_df, aes(x = cuts, y = search_rate)) +
  geom_col(fill = "#3498DB", color = "black") +
  labs(
    x = "Officer Age Group",
    y = "Proportion of Stops with Searches",
    title = "Search Rate by Officer Age Group"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```












